<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElevenLabs Translator Test</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }

        #preview-content {
            background: white;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        p {
            font-size: 18px;
            color: #333;
        }

        /* Debug: show c values on hover */
        span[c]:hover::after {
            content: " [c=" attr(c) "]";
            font-size: 10px;
            color: red;
        }
    </style>
</head>

<body>

    <div id="preview-content">
        <!-- Exact copy of elevenreader.io DOM structure -->
        <p style="line-height: 5;">
            <span c="1">Benyamin</span>
            <span c="10">Netanyahu</span>
            <span c="20">a</span>
            <span c="22">affirmé</span>
            <span c="30">ce</span>
            <span c="33">dimanche</span>
            <span c="42">21</span>
            <span c="45">septembre</span>
            <span c="55">qu'il</span>
            <span c="61">n'y</span>
            <span c="65">aura</span>
            <span c="70">pas</span>
            <span c="74">d'État</span>
            <span c="81">palestinien,</span>
            <span c="94">dans</span>
            <span c="99">une</span>
            <span c="103">vidéo</span>
            <span c="109">à</span>
            <span c="111">l'adresse</span>
            <span c="121">des</span>
            <span c="125">dirigeants</span>
            <span c="136">occidentaux</span>
            <span c="148">ayant</span>
            <span c="154">reconnu</span>
            <span c="162">plus</span>
            <span c="167">tôt</span>
            <span c="171">cet</span>
            <span c="175">État.</span>
        </p>
    </div>

    <script>
        // Mock Chrome API
        window.chrome = {
            storage: {
                sync: {
                    get: (keys, callback) => {
                        console.log("Mock chrome.storage.sync.get called with:", keys);
                        callback({
                            enabled: true,
                            openaiApiKey: "mock-key",
                            testingMode: true,
                            partitioningEnabled: true  // Enable meaning blocks
                        });
                    }
                },
                onChanged: {
                    _listeners: [],
                    addListener: function(fn) {
                        this._listeners.push(fn);
                        console.log("Storage listener registered, total:", this._listeners.length);
                    }
                }
            },
            runtime: {
                onMessage: {
                    addListener: () => { }
                },
                getURL: (path) => path,
                sendMessage: (message, callback) => {
                    console.log("Mock sendMessage:", message.action);

                    if (message.action === 'GET_MOCK_DATA' || message.action === 'TRANSLATE_WITH_POSITIONS') {
                        // Mock data with c values EXACTLY matching the DOM above
                        const mockData = {
                            "Clause": [
                                // "Benyamin Netanyahu a affirmé" - c:1 to c:22
                                { "start_c": 1, "end_c": 22, "translation": "Benjamin Netanyahu stated", "type": "Clause" },
                                // "ce dimanche 21 septembre" - c:30 to c:45
                                { "start_c": 30, "end_c": 45, "translation": "this Sunday, September 21st", "type": "Clause" },
                                // "qu'il n'y aura pas d'État palestinien" - c:55 to c:81
                                { "start_c": 55, "end_c": 81, "translation": "that there will be no Palestinian state", "type": "Clause" },
                                // "dans une vidéo à l'adresse des dirigeants occidentaux" - c:94 to c:136
                                { "start_c": 94, "end_c": 136, "translation": "in a video addressed to Western leaders", "type": "Clause" },
                                // "ayant reconnu plus tôt cet État" - c:148 to c:175
                                { "start_c": 148, "end_c": 175, "translation": "who recognized this state earlier", "type": "Clause" }
                            ],
                            "Sentence": [
                                { "start_c": 1, "end_c": 175, "translation": "Benjamin Netanyahu stated this Sunday, September 21st, that there will be no Palestinian state, in a video addressed to Western leaders who recognized this state earlier.", "type": "Sentence" }
                            ],
                            "Word": [
                                { "start_c": 1, "end_c": 1, "translation": "Benjamin", "type": "Word" },
                                { "start_c": 10, "end_c": 10, "translation": "Netanyahu", "type": "Word" },
                                { "start_c": 20, "end_c": 20, "translation": "has", "type": "Word" },
                                { "start_c": 22, "end_c": 22, "translation": "stated", "type": "Word" },
                                { "start_c": 30, "end_c": 30, "translation": "this", "type": "Word" },
                                { "start_c": 33, "end_c": 33, "translation": "Sunday", "type": "Word" },
                                { "start_c": 42, "end_c": 42, "translation": "21", "type": "Word" },
                                { "start_c": 45, "end_c": 45, "translation": "September", "type": "Word" },
                                { "start_c": 55, "end_c": 55, "translation": "that he", "type": "Word" },
                                { "start_c": 61, "end_c": 61, "translation": "there not", "type": "Word" },
                                { "start_c": 65, "end_c": 65, "translation": "will be", "type": "Word" },
                                { "start_c": 70, "end_c": 70, "translation": "not", "type": "Word" },
                                { "start_c": 74, "end_c": 74, "translation": "of state", "type": "Word" },
                                { "start_c": 81, "end_c": 81, "translation": "Palestinian", "type": "Word" },
                                { "start_c": 94, "end_c": 94, "translation": "in", "type": "Word" },
                                { "start_c": 99, "end_c": 99, "translation": "a", "type": "Word" },
                                { "start_c": 103, "end_c": 103, "translation": "video", "type": "Word" },
                                { "start_c": 109, "end_c": 109, "translation": "to", "type": "Word" },
                                { "start_c": 111, "end_c": 111, "translation": "the address", "type": "Word" },
                                { "start_c": 121, "end_c": 121, "translation": "of the", "type": "Word" },
                                { "start_c": 125, "end_c": 125, "translation": "leaders", "type": "Word" },
                                { "start_c": 136, "end_c": 136, "translation": "Western", "type": "Word" },
                                { "start_c": 148, "end_c": 148, "translation": "having", "type": "Word" },
                                { "start_c": 154, "end_c": 154, "translation": "recognized", "type": "Word" },
                                { "start_c": 162, "end_c": 162, "translation": "more", "type": "Word" },
                                { "start_c": 167, "end_c": 167, "translation": "early", "type": "Word" },
                                { "start_c": 171, "end_c": 171, "translation": "this", "type": "Word" },
                                { "start_c": 175, "end_c": 175, "translation": "State", "type": "Word" }
                            ],
                            "Phrase": [
                                { "start_c": 74, "end_c": 81, "translation": "Palestinian state", "type": "Phrase" },
                                { "start_c": 125, "end_c": 136, "translation": "Western leaders", "type": "Phrase" }
                            ],
                            "Proper Nouns": [
                                { "start_c": 1, "end_c": 10, "translation": "Benjamin Netanyahu", "type": "Proper Nouns" }
                            ]
                        };

                        console.log("Returning mock data - Clauses:", mockData.Clause.length);
                        console.log("First clause:", mockData.Clause[0]);
                        setTimeout(() => callback({ success: true, data: mockData }), 100);
                    }
                },
                lastError: null
            }
        };
    </script>
    <script src="content.js"></script>

    <!-- Debug Controls -->
    <div id="debug-controls" style="position: fixed; top: 10px; left: 10px; background: white; padding: 15px; border: 2px solid #333; border-radius: 8px; z-index: 99999; font-family: sans-serif; font-size: 14px;">
        <h3 style="margin: 0 0 10px 0;">Debug Controls</h3>
        <div style="margin-bottom: 10px;">
            <label><input type="checkbox" id="debug-clause" checked> Clause</label>
            <label style="margin-left: 10px;"><input type="checkbox" id="debug-word"> Word</label>
            <label style="margin-left: 10px;"><input type="checkbox" id="debug-phrase"> Phrase</label>
        </div>
        <button id="debug-check" style="padding: 5px 10px; margin-right: 5px;">Check State</button>
        <button id="debug-rerender" style="padding: 5px 10px;">Force Re-render</button>
        <div id="debug-output" style="margin-top: 10px; font-size: 12px; color: #666; max-height: 150px; overflow-y: auto;"></div>
    </div>

    <script>
        // Debug controls script
        const output = document.getElementById('debug-output');
        function log(msg) {
            output.innerHTML += msg + '<br>';
            output.scrollTop = output.scrollHeight;
        }

        document.getElementById('debug-check').onclick = function() {
            output.innerHTML = '';
            log('Body class: ' + document.body.className);
            log('Containers: ' + document.querySelectorAll('.clause-debug-container').length);
            log('Highlights: ' + document.querySelectorAll('.clause-debug-highlight').length);
            log('Translation overlays: ' + document.querySelectorAll('.translation-overlay').length);

            const containers = document.querySelectorAll('.clause-debug-container');
            containers.forEach((c, i) => {
                log(`Container ${i}: ${c.children.length} children, display=${getComputedStyle(c).display}`);
            });

            const highlights = document.querySelectorAll('.clause-debug-highlight');
            highlights.forEach((h, i) => {
                const style = getComputedStyle(h);
                log(`Highlight ${i}: type=${h.dataset.type}, bg=${style.backgroundColor}, pos=(${h.style.left}, ${h.style.top})`);
            });
        };

        document.getElementById('debug-rerender').onclick = function() {
            log('Triggering reRenderAll...');
            if (typeof reRenderAll === 'function') {
                reRenderAll();
            } else {
                log('reRenderAll not found in global scope');
            }
        };

        // Simulate storage change when checkboxes are toggled
        function updateSegTypes() {
            const types = {
                Clause: document.getElementById('debug-clause').checked,
                Word: document.getElementById('debug-word').checked,
                Phrase: document.getElementById('debug-phrase').checked,
                Sentence: false, Section: false, Paragraph: false,
                Collocation: false, Verbs: false, 'Proper Nouns': false
            };
            log('Updating segmentation types: ' + JSON.stringify(types));

            // Simulate storage change using the mock's listener array
            const listeners = chrome.storage.onChanged._listeners;
            log('Calling ' + listeners.length + ' storage listeners...');
            listeners.forEach(fn => {
                fn({ partitioningEnabled: { newValue: true } }, 'sync');
            });
        }

        document.getElementById('debug-clause').onchange = updateSegTypes;
        document.getElementById('debug-word').onchange = updateSegTypes;
        document.getElementById('debug-phrase').onchange = updateSegTypes;
    </script>

</body>

</html>
